# 项目结构说明

## 整体架构

```
ai-travel-planner/
├── backend/                 # Python后端服务
│   ├── app/                # 应用代码
│   │   ├── __init__.py
│   │   └── main.py         # FastAPI主应用
│   ├── pyproject.toml      # uv配置和依赖管理
│   └── .env.example        # 环境变量示例
├── frontend/               # Flutter Web前端
│   ├── lib/               # Dart源代码
│   │   ├── main.dart      # 应用入口
│   │   └── app.dart       # 主应用组件
│   ├── web/               # Web配置
│   │   └── index.html     # HTML入口文件
│   └── pubspec.yaml       # Flutter依赖配置
├── docs/                  # 项目文档
│   └── 项目结构说明.md     # 本文档
├── dev_plan/              # 开发计划文档
├── start_dev.sh           # 开发环境启动脚本
├── .gitignore            # Git忽略文件
└── README.md             # 项目说明
```

## 后端结构 (backend/)

### 应用代码 (app/)
- `main.py` - FastAPI应用主文件，包含API路由和中间件配置
- `models.py` - 数据模型定义
- `schemas.py` - Pydantic模型定义
- `database.py` - 数据库配置
- `auth.py` - 传统认证逻辑
- `srp_auth.py` - SRP安全认证实现
- `routers/` - API路由模块
  - `auth.py` - 认证相关路由
  - `users.py` - 用户管理路由
  - `trips.py` - 行程管理路由
- `middleware.py` - 中间件配置
- `crypto.py` - 加密工具函数

### 配置管理
- `pyproject.toml` - 使用uv进行Python包管理
- `.env.example` - 环境变量配置示例
- **重要**: API密钥由用户在前端配置，不在此处硬编码

## 前端结构 (frontend/)

### 源代码 (lib/)
- `main.dart` - Flutter应用入口点
- `app.dart` - 主应用组件和路由配置
- 后续将添加：
  - `pages/` - 页面组件
  - `widgets/` - 可复用组件
  - `models/` - 数据模型
  - `services/` - API服务
  - `providers/` - 状态管理

### Web配置 (web/)
- `index.html` - Web应用入口文件
- 包含高德地图API配置占位符

## 开发环境配置

### 后端开发
1. 安装uv包管理器
2. 复制 `.env.example` 为 `.env` 并配置
3. 运行 `uv sync` 安装依赖
4. 启动服务: `uv run uvicorn app.main:app --reload`

### 前端开发
1. 安装Flutter 3.0+
2. 启用Web支持: `flutter config --enable-web`
3. 安装依赖: `flutter pub get`
4. 启动开发服务器: `flutter run -d chrome`

### 一键启动
使用 `./start_dev.sh` 脚本同时启动前后端服务

## 安全认证机制

### SRP安全远程密码协议

项目使用SRP协议增强用户认证安全性，确保密码在不安全传输中不被泄露。

#### SRP认证流程
1. **注册**: 生成盐值和验证器，不存储密码
2. **挑战**: 服务器返回盐值和公钥
3. **认证**: 客户端和服务器相互验证
4. **令牌**: 认证成功后颁发JWT令牌

#### 相关文件
- `srp_auth.py` - SRP认证核心实现
- `routers/auth.py` - SRP认证API端点
- `test_srp_auth.py` - SRP认证测试脚本

### API密钥管理策略

**核心原则**: 所有API密钥与用户账户绑定，每个用户只能使用自己设置的API密钥。

#### 实现方式
1. **用户注册时**：提供API密钥配置选项（可选）
2. **账户设置**：用户可以随时更新API密钥
3. **服务调用**：使用当前登录用户的API密钥
4. **密钥存储**：使用用户密码加密存储在用户账户数据中

#### 支持的API服务
- OpenAI API (默认DeepSeek-chat)
- 高德地图API
- 科大讯飞语音识别API
- 智谱GLM搜索API

## 加密数据存储设计

### 端到端加密架构

项目采用端到端加密设计，确保用户行程数据的安全性：

#### 设计原则
- **后端职责**: 只负责存储加密数据，不处理业务逻辑
- **前端职责**: 负责数据加密解密和所有业务逻辑处理
- **加密机制**: 使用用户登录密码派生密钥进行AES加密

#### 加密数据流

1. **数据创建流程**:
   - 前端使用用户密码加密行程数据
   - 发送加密数据到后端存储
   - 后端只验证用户身份，不处理数据内容

2. **数据读取流程**:
   - 前端从后端获取加密数据
   - 使用用户密码解密数据
   - 在客户端处理所有业务逻辑

3. **数据更新流程**:
   - 前端加密更新后的数据
   - 发送加密数据到后端
   - 后端直接存储，不进行业务验证

#### 技术实现

- **加密算法**: AES-256 (Fernet)
- **密钥派生**: PBKDF2-HMAC-SHA256
- **盐值管理**: 每次加密生成随机盐值
- **数据格式**: JSON序列化后加密

#### 相关文件
- `models.py` - 行程模型包含encrypted_data字段
- `schemas.py` - 行程API模型定义
- `routers/trips.py` - 行程API端点（只处理加密数据）
- `crypto.py` - 加密工具函数

## 开发注意事项

1. **跨域问题**: 后端已配置CORS中间件支持前端访问
2. **环境变量**: 敏感配置通过环境变量管理
3. **依赖管理**: 使用uv和pub进行包管理
4. **代码规范**: 遵循Python和Dart的代码规范
5. **错误处理**: 实现完善的错误处理和用户提示
6. **加密测试**: 使用测试脚本验证加密机制

## 测试验证

### 加密存储机制测试
运行以下测试脚本验证端到端加密设计：
```bash
cd backend
uv run python test_full_encrypted_workflow.py
```

## 后续开发计划

参考 `dev_plan/` 目录中的开发计划文档，按阶段逐步实现功能。