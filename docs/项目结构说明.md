# 项目结构说明

## 整体架构

```
ai-travel-planner/
├── backend/                 # Python后端服务
│   ├── app/                # 应用代码
│   │   ├── routers/        # API路由模块
│   │   │   ├── auth.py    # 认证相关路由
│   │   │   ├── users.py   # 用户管理路由
│   │   │   ├── trips.py   # 行程管理路由
│   │   │   └── speech.py  # 语音识别路由
│   │   ├── models/        # SQLAlchemy数据模型
│   │   ├── schemas/       # Pydantic模型定义
│   │   ├── auth.py        # 传统认证逻辑
│   │   ├── srp_auth.py    # SRP安全认证实现
│   │   ├── database.py    # 数据库配置
│   │   ├── middleware.py  # 中间件配置
│   │   └── main.py        # FastAPI主应用
│   ├── pyproject.toml     # uv配置和依赖管理
│   ├── .env.example       # 环境变量示例
│   └── create_tables.py   # 数据库表创建脚本
├── frontend/               # React + TypeScript + Vite前端
│   ├── src/               # TypeScript源代码
│   │   ├── components/    # 可复用组件
│   │   │   ├── Layout.tsx    # 主布局组件
│   │   │   ├── Header.tsx    # 顶部导航栏
│   │   │   ├── Sidebar.tsx   # 侧边栏导航
│   │   │   ├── MapComponent.tsx # 地图组件
│   │   │   └── SpeechInput.tsx  # 语音输入组件
│   │   ├── pages/         # 页面组件
│   │   │   ├── auth/      # 认证页面
│   │   │   ├── trips/     # 行程管理页面
│   │   │   ├── chat/      # 聊天页面
│   │   │   ├── search/    # 搜索页面
│   │   │   ├── home/      # 首页
│   │   │   └── settings/  # 设置页面
│   │   ├── services/      # API服务
│   │   │   ├── authService.ts    # 认证服务
│   │   │   ├── tripService.ts    # 行程服务
│   │   │   ├── llmService.ts     # AI服务
│   │   │   ├── userService.ts    # 用户服务
│   │   │   ├── leafletService.ts # 地图服务
│   │   │   └── speechService.ts  # 语音识别服务
│   │   ├── stores/         # 状态管理
│   │   │   └── authStore.ts      # 认证状态管理
│   │   ├── types/          # TypeScript类型定义
│   │   │   └── index.ts
│   │   ├── App.tsx         # 主应用组件
│   │   ├── main.tsx        # 应用入口
│   │   └── index.css       # 全局样式
│   ├── package.json        # Node.js依赖配置
│   ├── vite.config.ts      # Vite构建配置
│   ├── tsconfig.json       # TypeScript配置
│   ├── tailwind.config.js  # Tailwind CSS配置
│   └── index.html          # HTML入口文件
├── docs/                  # 项目文档
│   ├── 项目结构说明.md     # 本文档
│   ├── 后端API文档.md      # API接口文档
│   └── 行程JSON结构说明.md # 数据结构文档
├── dev_plan/              # 开发计划文档
├── .gitignore            # Git忽略文件
├── docker-compose.yml     # Docker编排配置
├── Dockerfile.local      # 本地Docker配置
├── nginx.conf            # Nginx配置
├── build.sh             # 构建脚本
├── start.sh             # 启动脚本
└── README.md            # 项目说明
```

## 后端结构 (backend/)

### 应用代码 (app/)
- `main.py` - FastAPI应用主文件，包含API路由和中间件配置
- `models.py` - SQLAlchemy数据模型定义
- `schemas.py` - Pydantic模型定义
- `database.py` - 数据库配置和连接管理
- `auth.py` - 传统认证逻辑和JWT令牌管理
- `srp_auth.py` - SRP安全认证实现
- `middleware.py` - JWT认证中间件和用户验证
- `utils/` - 工具函数
  - `srp_dataType.py` - SRP数据类型定义

### API路由模块 (routers/)
- `auth.py` - 认证相关路由
  - SRP注册/登录
  - 不安全密码传输
  - 令牌验证和注销
- `users.py` - 用户管理路由
  - 用户信息获取和更新
  - API密钥管理
  - 用户账户删除
- `trips.py` - 行程管理路由
  - 行程CRUD操作
  - 行程列表和分页
  - 行程状态管理
- `speech.py` - 语音识别路由
  - WebSocket语音识别服务
  - 讯飞API代理转发
  - 实时音频处理

### 配置管理
- `pyproject.toml` - 使用uv进行Python包管理
- `.env.example` - 环境变量配置示例
- `create_tables.py` - 数据库表创建脚本
- **重要**: API密钥由用户在前端配置，不在此处硬编码

## 前端结构 (frontend/)

### 源代码 (src/)
- `main.tsx` - React应用入口点
- `App.tsx` - 主应用组件和路由配置
- `components/` - 可复用组件
  - `Layout.tsx` - 主布局组件
  - `Header.tsx` - 顶部导航栏
  - `Sidebar.tsx` - 侧边栏导航
  - `MapComponent.tsx` - 地图组件

### 页面组件 (pages/)
- `auth/` - 认证页面
  - `LoginPage.tsx` - 登录页面
  - `RegisterPage.tsx` - 注册页面
- `trips/` - 行程管理页面
  - `TripLayoutPage.tsx` - 行程布局页面
  - `AITripPlanningPage.tsx` - AI行程规划页面
  - `TripDetailPage.tsx` - 行程详情页面
- `chat/` - 聊天页面
  - `ChatPage.tsx` - AI聊天助手页面
- `search/` - 搜索页面
  - `SearchPage.tsx` - 智能搜索页面
- `home/` - 首页
  - `HomePage.tsx` - 行程概览页面
- `settings/` - 设置页面
  - `SettingsPage.tsx` - 通用设置页面
  - `ApiKeysPage.tsx` - API密钥配置页面

### 服务层 (services/)
- `authService.ts` - 认证服务（登录、注册、令牌管理）
- `tripService.ts` - 行程服务（CRUD操作、数据转换）
- `llmService.ts` - AI服务（OpenAI集成、流式响应）
- `userService.ts` - 用户服务（用户信息、API密钥管理）
- `leafletService.ts` - 地图服务（Leaflet集成、路线规划）
- `speechService.ts` - 语音识别服务（讯飞API集成、音频处理）

### 状态管理 (stores/)
- `authStore.ts` - Zustand认证状态管理
  - 用户登录状态
  - 令牌管理
  - 用户信息缓存

### 类型定义 (types/)
- `index.ts` - TypeScript类型定义
  - 用户相关类型
  - 行程相关类型
  - API响应类型
  - 地图相关类型
  - AI相关类型

### 配置和构建
- `package.json` - Node.js依赖配置
- `vite.config.ts` - Vite构建工具配置
- `tsconfig.json` - TypeScript配置
- `tsconfig.node.json` - Node.js TypeScript配置
- `tailwind.config.js` - Tailwind CSS配置
- `postcss.config.js` - PostCSS配置
- `index.html` - HTML入口文件

## 开发环境配置

### 后端开发
1. 安装uv包管理器
2. 复制 `.env.example` 为 `.env` 并配置
3. 运行 `uv sync` 安装依赖
4. 创建数据库表: `python create_tables.py`
5. 启动服务: `uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`

### 前端开发
1. 安装Node.js 16+
2. 安装依赖: `npm install`
3. 配置环境变量（可选）: 创建 `.env` 文件设置 `VITE_API_BASE_URL`
4. 启动开发服务器: `npm run dev`

### 开发环境启动
```bash
# 启动后端服务
cd backend
uv sync
python create_tables.py
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 启动前端服务（新终端）
cd frontend
npm install
npm run dev
```

### 访问应用
- 前端界面: http://localhost:5173
- 后端API: http://localhost:8000
- API文档: http://localhost:8000/docs

## 安全认证机制

### SRP安全远程密码协议

项目使用SRP协议增强用户认证安全性，确保密码在不安全传输中不被泄露。

#### SRP认证流程
1. **注册**: 生成盐值和验证器，不存储密码
2. **挑战**: 服务器返回盐值和公钥
3. **认证**: 客户端和服务器相互验证
4. **令牌**: 认证成功后颁发JWT令牌

#### 相关文件
- `srp_auth.py` - SRP认证核心实现
- `routers/auth.py` - SRP认证API端点
- `test_srp_auth.py` - SRP认证测试脚本

### API密钥管理策略

**核心原则**: 所有API密钥与用户账户绑定，每个用户只能使用自己设置的API密钥。

#### 实现方式
1. **用户注册时**：提供API密钥配置选项（可选）
2. **账户设置**：用户可以随时更新API密钥
3. **服务调用**：使用当前登录用户的API密钥
4. **密钥存储**：使用用户密码加密存储在用户账户数据中

#### 支持的API服务
- OpenAI API (默认DeepSeek-chat)
- 高德地图API
- 科大讯飞语音识别API (已实现)
- 智谱GLM搜索API

## 数据存储设计

### 明文数据存储架构

项目采用明文JSON数据存储设计，便于后端处理和业务逻辑实现：

#### 设计原则
- **后端职责**: 存储和处理完整的行程数据结构
- **前端职责**: 负责用户界面交互和数据展示
- **数据格式**: 使用JSON格式存储完整的行程信息

#### 数据流

1. **数据创建流程**:
   - 前端准备完整的行程数据结构
   - 发送明文JSON数据到后端存储
   - 后端验证数据格式并存储

2. **数据读取流程**:
   - 前端从后端获取完整的行程数据
   - 直接在客户端展示和处理数据

3. **数据更新流程**:
   - 前端准备更新后的行程数据
   - 发送明文JSON数据到后端
   - 后端验证并更新数据

#### 技术实现

- **数据格式**: JSON格式，包含完整的行程结构
- **存储类型**: 数据库JSON字段，便于查询和处理
- **验证机制**: 后端进行数据格式验证

#### 相关文件
- `models.py` - 行程模型包含trip_data字段
- `schemas.py` - 行程API模型定义
- `routers/trips.py` - 行程API端点（处理完整行程数据）

## 开发注意事项

1. **跨域问题**: 后端已配置CORS中间件支持前端访问
2. **环境变量**: 敏感配置通过环境变量管理
3. **依赖管理**: 使用uv和npm进行包管理
4. **代码规范**: 遵循Python和TypeScript的代码规范
5. **错误处理**: 实现完善的错误处理和用户提示
6. **类型安全**: 使用TypeScript确保前端代码质量
7. **地图服务**: 使用开源地图服务，无需API密钥
8. **AI服务**: 需要用户自行配置API密钥

## 测试验证

### 数据存储机制测试
运行以下测试脚本验证数据存储功能：
```bash
cd backend
uv run python pseudo_client4test.py
```

### 前端测试
```bash
cd frontend
npm run lint        # 代码检查
npm run type-check  # 类型检查
npm run build      # 构建测试
```

## 技术栈详情

### 前端技术栈
- **React 18** - 用户界面框架
- **TypeScript** - 类型安全的JavaScript
- **Vite** - 快速构建工具
- **Tailwind CSS** - 实用优先的CSS框架
- **React Router** - 客户端路由
- **Zustand** - 轻量级状态管理
- **Axios** - HTTP客户端
- **Leaflet** - 开源地图库
- **Lucide React** - 图标库

### 后端技术栈
- **FastAPI** - 现代Python Web框架
- **SQLAlchemy** - Python SQL工具包
- **Pydantic** - 数据验证和设置管理
- **SQLite** - 轻量级数据库
- **JWT** - JSON Web令牌认证
- **SRP** - 安全远程密码协议
- **uv** - 快速Python包管理器

## 后续开发计划

参考 `dev_plan/` 目录中的开发计划文档，按阶段逐步实现功能。