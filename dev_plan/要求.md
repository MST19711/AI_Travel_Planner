# Web ç‰ˆAI æ—…è¡Œè§„åˆ’å¸ˆ (AI Travel Planner)

## ä¸€ã€è¯´æ˜ï¼š

è½¯ä»¶æ—¨åœ¨ç®€åŒ–æ—…è¡Œè§„åˆ’è¿‡ç¨‹ï¼Œé€šè¿‡ AI äº†è§£ç”¨æˆ·éœ€æ±‚ï¼Œè‡ªåŠ¨ç”Ÿæˆè¯¦ç»†çš„æ—…è¡Œè·¯çº¿å’Œå»ºè®®ï¼Œå¹¶æä¾›å®æ—¶æ—…è¡Œè¾…åŠ©ã€‚

## äºŒã€æ ¸å¿ƒåŠŸèƒ½ï¼š

1ã€æ™ºèƒ½è¡Œç¨‹è§„åˆ’: ç”¨æˆ·å¯ä»¥é€šè¿‡è¯­éŸ³ï¼ˆæˆ–æ–‡å­—ï¼Œè¯­éŸ³åŠŸèƒ½ä¸€å®šè¦æœ‰ï¼‰è¾“å…¥æ—…è¡Œç›®çš„åœ°ã€æ—¥æœŸã€é¢„ç®—ã€åŒè¡Œäººæ•°ã€æ—…è¡Œåå¥½ï¼ˆä¾‹å¦‚ï¼šâ€œæˆ‘æƒ³å»æ—¥æœ¬ï¼Œ5 å¤©ï¼Œé¢„ç®— 1 ä¸‡å…ƒï¼Œå–œæ¬¢ç¾é£Ÿå’ŒåŠ¨æ¼«ï¼Œå¸¦å­©å­â€ï¼‰ï¼ŒAI ä¼šè‡ªåŠ¨ç”Ÿæˆä¸ªæ€§åŒ–çš„æ—…è¡Œè·¯çº¿ï¼ŒåŒ…æ‹¬äº¤é€šã€ä½å®¿ã€æ™¯ç‚¹ã€é¤å…ç­‰è¯¦ç»†ä¿¡æ¯ã€‚

2ã€è´¹ç”¨é¢„ç®—ä¸ç®¡ç†: ç”± AI è¿›è¡Œé¢„ç®—åˆ†æï¼Œè®°å½•æ—…è¡Œå¼€é”€ï¼ˆæ¨èå¯ä»¥ä½¿ç”¨è¯­éŸ³ï¼‰ã€‚

3ã€ç”¨æˆ·ç®¡ç†ä¸æ•°æ®å­˜å‚¨:

æ³¨å†Œç™»å½•ç³»ç»Ÿ: ç”¨æˆ·å¯ä»¥ä¿å­˜å’Œç®¡ç†å¤šä»½æ—…è¡Œè®¡åˆ’ã€‚

**å®‰å…¨è¦æ±‚**:
- **å¯†ç å®‰å…¨**: ä½¿ç”¨SRPï¼ˆSecure Remote Passwordï¼‰åè®®è¿›è¡Œç”¨æˆ·è®¤è¯ï¼ŒæœåŠ¡å™¨ä¸å­˜å‚¨ç”¨æˆ·å¯†ç ï¼Œåªå­˜å‚¨éªŒè¯å™¨
- **æ•°æ®åŠ å¯†**: è¡Œç¨‹æ•°æ®ä½¿ç”¨ç”¨æˆ·ç™»å½•å¯†ç è¿›è¡Œç«¯åˆ°ç«¯åŠ å¯†ï¼Œåç«¯åªå­˜å‚¨åŠ å¯†æ•°æ®ï¼Œå‰ç«¯è´Ÿè´£æ‰€æœ‰åŠ å¯†è§£å¯†æ“ä½œ
- **APIå¯†é’¥åŠ å¯†**: APIå¯†é’¥ä½¿ç”¨ç”¨æˆ·ç™»å½•å¯†ç è¿›è¡ŒåŠ å¯†å­˜å‚¨ï¼Œä½¿ç”¨æ—¶ç”±å®¢æˆ·ç«¯ä½¿ç”¨ç™»å½•å¯†ç è‡ªåŠ¨è§£å¯†
- **åŠ å¯†å­˜å‚¨è®¾è®¡**:
  - åç«¯åªè´Ÿè´£å­˜å‚¨åŠ å¯†æ•°æ®ï¼Œä¸å¤„ç†ä¸šåŠ¡é€»è¾‘
  - å‰ç«¯è´Ÿè´£æ•°æ®åŠ å¯†è§£å¯†å’Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘å¤„ç†
  - ä½¿ç”¨ç”¨æˆ·å¯†ç æ´¾ç”Ÿå¯†é’¥è¿›è¡ŒAESåŠ å¯†
  - æ•°æ®åœ¨ä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­å§‹ç»ˆåŠ å¯†

äº‘ç«¯è¡Œç¨‹åŒæ­¥: æ—…è¡Œè®¡åˆ’ã€åå¥½è®¾ç½®ã€è´¹ç”¨è®°å½•ç­‰æ•°æ®äº‘ç«¯åŒæ­¥ï¼Œæ–¹ä¾¿å¤šè®¾å¤‡æŸ¥çœ‹å’Œä¿®æ”¹ã€‚

## ä¸‰ã€æŠ€æœ¯æ ˆï¼ˆ Webï¼‰

è¯­éŸ³è¯†åˆ«ï¼šåŸºäºç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ« API æä¾›è¯­éŸ³è¯†åˆ«åŠŸèƒ½

åœ°å›¾å¯¼èˆªï¼šåŸºäºé«˜å¾·API æä¾›åœ°ç†ä½ç½®æœåŠ¡å’Œå¯¼èˆªåŠŸèƒ½

æ•°æ®åº“/è®¤è¯ï¼šå…ˆä½¿ç”¨sqliteï¼Œå¾…é¡¹ç›®å‘å±•åœ¨æ›´æ¢å…¶ä»–æ•°æ®åº“åç«¯ã€‚

è¡Œç¨‹è§„åˆ’å’Œè´¹ç”¨é¢„ç®—ï¼šé€šè¿‡å¤§è¯­è¨€æ¨¡å‹å®Œæˆå½¢æˆè§„åˆ’å’Œè´¹ç”¨é¢„ç®—çš„ä¼°è®¡

UI/UXï¼š åœ°å›¾ä¸ºä¸»çš„äº¤äº’ç•Œé¢ï¼Œæ¸…æ™°çš„è¡Œç¨‹å±•ç¤ºï¼Œç¾è§‚çš„å›¾ç‰‡ã€‚

å‰ç«¯ï¼šä½¿ç”¨React + TypeScript + Viteæ„å»ºWebå‰ç«¯ï¼ˆæ³¨ï¼šåŸè®¡åˆ’ä½¿ç”¨Flutterï¼Œå®é™…å®ç°å·²æ”¹ä¸ºReactï¼‰

åç«¯ï¼špython+fastAPIï¼Œpythonä½¿ç”¨uvç®¡ç†ç¯å¢ƒã€‚

LLMï¼šä½¿ç”¨OpenAI APIï¼Œé»˜è®¤ä½¿ç”¨deepseek-chatæ¨¡å‹

æœç´¢ï¼šä½¿ç”¨æ™ºè°±ï¼ˆGLMï¼‰æœç´¢API

æ³¨æ„ï¼Œæ‰€æœ‰é¡¹ç›®ç›¸å…³çš„æ–‡ä»¶ï¼ˆåŒ…æ‹¬ç¯å¢ƒï¼‰è¯·å­˜æ”¾åˆ°é¡¹ç›®ç›®å½•ä¸­ã€‚

## å››ã€å…·ä½“è®¾è®¡

é¡¹ç›®éœ€è¦å…ˆç™»é™†æ‰èƒ½ä½¿ç”¨

æ³¨å†Œæ—¶è¦æ±‚ç”¨æˆ·æä¾›LLMã€é«˜å¾·ã€æ™ºè°±ï¼ˆGLMï¼‰æœç´¢APIå’Œç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«çš„API KEYï¼Œä½†å…è®¸ä¸ºç©ºã€‚API KEYä¸ºç©ºæ—¶ç›¸å…³æœåŠ¡ä¸å¯ç”¨ä½†ä¸å½±å“å…¶ä»–æœåŠ¡ã€‚

**é‡è¦ï¼šæ‰€æœ‰APIå¯†é’¥å°†ä¸ç”¨æˆ·è´¦æˆ·ç»‘å®šï¼Œæ¯ä¸ªç”¨æˆ·åªèƒ½ä½¿ç”¨è‡ªå·±è®¾ç½®çš„APIå¯†é’¥ã€‚ç³»ç»Ÿä¸ä¼šä½¿ç”¨ä»»ä½•å…¨å±€æˆ–é»˜è®¤çš„APIå¯†é’¥ã€‚**

åœ¨è´¦æˆ·è®¾ç½®ç•Œé¢ï¼Œç”¨æˆ·å¯ä»¥æ›´æ”¹API KEYä»¥åŠæ›´æ¢LLM URLå’Œmodel nameï¼ˆè¿™ä¸¤é¡¹é»˜è®¤ä½¿ç”¨DeepSeek å’ŒDeepSeek-chatï¼‰

ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨åˆ›å»ºè¡Œç¨‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨AIæ ¹æ®æè¿°ç”Ÿæˆè¡Œç¨‹ã€‚ç”Ÿæˆçš„è¡Œç¨‹å…è®¸æ‰‹åŠ¨æ›´æ”¹ã€‚æ¯ä¸ªæ—…è¡Œè®¡åˆ’ç”±è‹¥å¹²ä¸ªå­è¡Œç¨‹æ„æˆï¼Œæ¯ä¸ªå­è¡Œç¨‹éœ€è¦æä¾›åœ°ç‚¹ã€æ—¶é—´ï¼ˆèµ·å§‹å’Œç»ˆæ­¢ï¼‰å’Œé¢„è®¡å¼€é”€ã€‚åœ°ç‚¹éœ€è¦åŒ…å«åŸå¸‚åç§°å’Œå›½å®¶ä»£ç ï¼ˆæ‰‹åŠ¨åˆ›å»ºæ—¶åº”å…è®¸ç”¨æˆ·é€šè¿‡å›½å®¶åç§°è®¾ç½®å›½å®¶ä»£ç ï¼‰ã€‚

ä½¿ç”¨AIåˆ›å»ºè¡Œç¨‹æ—¶ï¼ŒAIæ ¹æ®ç”¨æˆ·çš„éœ€æ±‚ç”Ÿæˆjsonæ ¼å¼çš„è¡Œç¨‹å®‰æ’ï¼Œå…¶ä¸­åº”è¯¥åŒ…æ‹¬æœ¬æ–‡æ¡£çš„éœ€æ±‚éœ€è¦çš„å†…å®¹ä»¥åŠåŸå¸‚åç§°å’Œå›½å®¶ä»£ç ä»¥ä¾¿åœ°å›¾APIä½¿ç”¨ã€‚å¦‚æœç”¨æˆ·é…ç½®äº†æœç´¢APIï¼ŒAIå¯ä»¥ä½¿ç”¨å·¥å…·è°ƒç”¨çš„æ–¹å¼ä½¿ç”¨æœç´¢APIè¿›è¡Œè¯¦ç»†æœç´¢ç„¶åå†æ ¹æ®æœç´¢ç»“æœåˆ›å»ºè®¡åˆ’ã€‚å¦‚æœå¯¹äºæŸä¸ªæ—…è¡Œè®¡åˆ’ï¼Œå·²ç»å­˜åœ¨äº†ä¸€äº›è¡Œç¨‹ï¼Œåˆ™ä½¿ç”¨AIæ—¶åº”å½“ä¼ å…¥å·²æœ‰è¡Œç¨‹è®©AIæ ¹æ®éœ€æ±‚ä¿®æ”¹ï¼Œå¦åˆ™ç›´æ¥è®©AIç”Ÿæˆå®Œæ•´çš„è¡Œç¨‹ã€‚AIç”Ÿæˆæˆ–è°ƒæ•´è¡Œç¨‹ä¹‹åè¯·åŠ¡å¿…æ£€æŸ¥è¾“å‡ºçš„jsonä»¥åŠå…¶ä¸­å†…å®¹æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œä¸ç¬¦åˆåˆ™å°†æ£€æŸ¥ç»“æœï¼ˆä¸ç¬¦åˆåŸå› ï¼‰ä¸æœ‰é—®é¢˜çš„jsonä¼ å…¥AIä»¤å…¶æ›´æ”¹ã€‚å¦‚æœå·²ç»è¿›è¡Œè¿‡æ›´æ”¹è¯·ä½¿ç”¨æ–°çš„æ›´æ”¹è¦æ±‚å’Œé—®é¢˜jsonæ›¿æ¢ä¸Šä¸‹æ–‡ä¸­åŸæœ‰çš„ç›¸åº”å†…å®¹ã€‚å¦‚æœä½¿ç”¨äº†æœç´¢ï¼Œè¡Œç¨‹ç›¸å…³ä¿¡æ¯ï¼ˆå¦‚åœ°ç‚¹/è€—æ—¶/é¢„è®¡å¼€é”€ç­‰ï¼‰å°½é‡æ¥æºäºæœç´¢ç»“æœã€‚å¦‚æœé…ç½®äº†æœç´¢APIåˆ™å¤§æ¨¡å‹éšæ—¶å¯ä»¥ä½¿ç”¨æœç´¢å·¥å…·ã€‚å¤§æ¨¡å‹ç›¸å…³å†…å®¹å°½é‡æ”¾åˆ°åç«¯pythonä¸­ï¼Œä»è€Œä¾¿äºå¼€å‘å’Œè°ƒè¯•ã€‚

é¢„ç®—åˆ†æåŠŸèƒ½åº”å½“æ ¹æ®æ—…è¡Œè®¡åˆ’ä¸­æ‰€æœ‰å­è¡Œç¨‹çš„é¢„è®¡å¼€é”€è¿›è¡Œã€‚å°†æ‰€æœ‰å­è¡Œç¨‹çš„ä¿¡æ¯ä»¥åŠæ‰€æœ‰å­è¡Œç¨‹é¢„è®¡å¼€é”€ä¹‹å’Œï¼ˆä»¥åŠå¯é€‰çš„éœ€æ±‚ï¼‰ä¼ å…¥AIè¿›è¡Œåˆ†æã€‚å¦‚æœé…ç½®äº†æœç´¢APIï¼Œå¯ä»¥è®©AIä»¥å·¥å…·è°ƒç”¨çš„æ–¹å¼ä½¿ç”¨è¯¥æœç´¢APIã€‚é¢„ç®—åˆ†æåº”å½“ä½¿ç”¨äººæ°‘å¸è¿›è¡Œåˆ†æã€‚

æœ¬é¡¹ç›®çš„UIæš‚æ—¶åªè€ƒè™‘PCä»¥åŠæ¨ªå±æµè§ˆï¼ˆå³å±å¹•ä¸ºé•¿æ–¹å½¢ï¼‰ã€‚

ä¸»uiåº”å½“æ˜¯ä¸€ä¸ªæ—…è¡Œè®¡åˆ’åˆ—è¡¨ï¼Œç‚¹å‡»æŸä¸ªè®¡åˆ’è¿›å…¥è¯¥è®¡åˆ’çš„å­é¡µé¢åå¯ä»¥è¿›å…¥æŸ¥çœ‹å­è¡Œç¨‹ã€‚UIæ˜¾ç¤ºæ—¶åŒä¸€å¤©çš„å­è¡Œç¨‹åº”å½“å¤„äºåŒä¸€ä¸ªè§†è§‰å…ƒç´ ä¸­ï¼Œä»è€Œå¯ä»¥ç›´è§‚çš„çœ‹åˆ°ä¸åŒæ—¥æœŸçš„è¡Œç¨‹ã€‚æ—…è¡Œè®¡åˆ’å­é¡µé¢ä¸­å·¦ä¾§åº”å½“ä¸ºå­è¡Œç¨‹åˆ—è¡¨ï¼Œå³ä¾§æœ‰ä¸€ä¸ªåœ°å›¾ï¼ˆä½¿ç”¨é«˜å¾·åœ°å›¾APIï¼‰è¿™ä¸ªç•Œé¢å¯ä»¥åˆ‡æ¢æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼ï¼Œå¤„äºç¼–è¾‘æ¨¡å¼ä¸‹å·¦ä¾§å¯ä»¥æ‰‹åŠ¨æ·»åŠ /åˆ é™¤è¡Œç¨‹ä»¥åŠç¼–è¾‘è¡Œç¨‹ä¿¡æ¯ã€‚ç¼–è¾‘æ¨¡å¼ä¸‹ç”¨æˆ·å¯ä»¥ä½¿ç”¨AIè§„åˆ’è¡Œç¨‹ï¼Œç‚¹å‡»ç›¸å…³æŒ‰é’®ä¹‹åå¼¹å‡ºå¼¹çª—è®©ç”¨æˆ·è¾“å…¥è‡ªå·±çš„éœ€æ±‚ï¼Œè¯¥å¼¹çª—ä¸‹ä¹Ÿæœ‰æŒ‰é’®å…è®¸ç”¨æˆ·ä½¿ç”¨è¯­éŸ³è¾“å…¥ï¼ˆåŸºäºç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ« API æä¾›è¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼‰ã€‚ç”¨æˆ·ç‚¹å‡»å·¦ä¾§æŸä¸ªåœ°å€ä¹‹åå³ä¾§åœ°å›¾ä¸Šæ˜¾ç¤ºè¯¥åœ°å€æœç´¢ç»“æœçš„æ’åé å‰çš„åœ°ç‚¹ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»é€‰æ‹©å…¶ä¸­ä¹‹ä¸€ï¼Œé€‰æ‹©åå…¶ä»–åœ°ç‚¹ä¸å†æ˜¾ç¤ºï¼ˆæˆ–å¿…é¡»åšå‡ºæ˜ç¡®è§†è§‰åŒºåˆ†ä¸”ä¸èƒ½å†é€‰æ‹©ï¼‰ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰é€‰æ‹©ï¼Œåˆ™ç‚¹å‡»å…¶ä»–å­è¡Œç¨‹æ—¶åœ°å›¾ä¸Šæ˜¾ç¤ºçš„åœ°ç‚¹æ›´æ–°ä¸ºæ–°é€‰æ‹©çš„å­è¡Œç¨‹åœ°ç‚¹åç§°åœ¨åœ°å›¾APIæœç´¢ç»“æœçš„é å‰é¡¹ã€‚å¦‚æœç”¨æˆ·å·²ç»é€‰æ‹©äº†ä¸€ä¸ªåœ°å€ï¼Œåˆ™ç‚¹å‡»å…¶ä»–å­è¡Œç¨‹æ—¶è¢«é€‰æ‹©çš„åœ°ç‚¹åº”å½“ä¿ç•™ï¼Œæœªè¢«é€‰æ‹©çš„ä½ç½®æ¶ˆå¤±ã€‚è¢«é€‰æ‹©çš„ç‚¹å†æ¬¡ç‚¹å‡»åå¯ä»¥å–æ¶ˆé€‰æ‹©ï¼ˆå¦‚æœè¯¥ç‚¹ä¸å±äºç›®å‰é€‰ä¸­çš„æ´»åŠ¨åˆ™æ¶ˆå¤±ï¼‰ã€‚ç•Œé¢æœ€å³ä¾§åº”è¯¥æœ‰ä¸€ä¸ªå¯ä»¥ç‚¹å‡»å‘¼å‡ºæˆ–éšè—çš„çª—å£ã€‚è¯¥çª—å£ä¸­ä¸€åˆ—è¡¨å½¢å¼å±•ç¤ºå·²ç»è¢«é€‰æ‹©çš„åœ°ç‚¹ï¼Œç”¨æˆ·å¯ä»¥è°ƒæ•´è¿™äº›åœ°ç‚¹çš„é¡ºåºå¹¶é€‰æ‹©äº¤é€šæ–¹å¼ç„¶åç”ŸæˆæŒ‰ç…§ç”¨æˆ·è°ƒæ•´åé¡ºåºè¿æ¥èµ·è¿™äº›ç‚¹çš„å¯¼èˆªæ–¹æ¡ˆï¼ˆå¦‚æœäº¤é€šæ–¹å¼ä¸‹APIä¸æ”¯æŒé€”å¾„ç‚¹ï¼Œåˆ™åº”å½“è¯´æ˜ï¼Œå¹¶è®©ç”¨æˆ·åœ¨å³ä¾§é€‰æ‹©ä¸¤ä¸ªï¼ˆæœ€å°‘ä¹Ÿæœ€å¤šä¸¤ä¸ªç‚¹ï¼Œå·²ç»é€‰æ‹©ä¸¤ä¸ªç‚¹æ—¶å¦‚æœåˆé€‰æ‹©æ–°çš„ç‚¹çš„å¼¹å‡ºæç¤ºå¹¶æ‹’ç»åœ°ç‚¹è¢«é€‰æ‹©ï¼›å¦‚æœåªé€‰æ‹©äº†ä¸€ä¸ªç‚¹æˆ–æ›´å°‘åˆ™ç‚¹å‡»ç”Ÿæˆå¯¼èˆªæ–¹æ¡ˆæ—¶å¼¹å‡ºç›¸åº”æç¤ºï¼‰åœ°ç‚¹ç„¶åç”Ÿæˆè¿™ä¸¤ä¸ªåœ°ç‚¹ä¹‹é—´çš„å¯¼èˆªä¿¡æ¯ï¼›å¦‚æœäº¤é€šæ–¹å¼æ”¯æŒé€”å¾„ç‚¹åˆ™é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æ‰€æœ‰ä¸­é—´ç‚¹ä½œä¸ºé€”å¾„ç‚¹ï¼Œä½†ä¹Ÿå¯ä»¥æ‰‹åŠ¨é€‰æ‹©è¶…è¿‡ä¸¤ä¸ªç‚¹ç„¶åå‘APIæŸ¥è¯¢æŒ‰ç…§é¡ºåºç»è¿‡è¿™äº›ç‚¹çš„å¯¼èˆªä¿¡æ¯ï¼‰ï¼Œå¹¶æä¾›è€—æ—¶é¢„ä¼°ã€‚

## äº”ã€APIæ–‡æ¡£

---

# é«˜å¾·

### ä¸€ã€å‡†å¤‡å·¥ä½œ

### 1. æ³¨å†Œå¼€å‘è€…è´¦å·å’Œè·å–API Key

é¦–å…ˆéœ€è¦åœ¨é«˜å¾·å¼€æ”¾å¹³å°æ³¨å†Œè´¦å·ï¼Œåˆ›å»ºåº”ç”¨å¹¶è·å–Webç«¯API Keyï¼š

```dart
// é«˜å¾·åœ°å›¾API Keyï¼ˆéœ€è¦æ›¿æ¢ä¸ºæ‚¨çš„å®é™…Keyï¼‰
const String AMAP_API_KEY = 'æ‚¨çš„é«˜å¾·åœ°å›¾Web API Key';
```

### 2. Flutter Webé¡¹ç›®é…ç½®

åœ¨ `pubspec.yaml`ä¸­æ·»åŠ å¿…è¦çš„ä¾èµ–ï¼š

```yaml
dependencies:
  flutter:
    sdk: flutter
  js: ^0.6.7
  http: ^0.13.6
  geojson: ^1.0.6

dev_dependencies:
  build_web_compilers: ^4.0.0
  build_runner: ^2.4.4
```

## äºŒã€åŸºç¡€åœ°å›¾å±•ç¤º

### 1. åˆ›å»ºHTMLå®¹å™¨

åœ¨ `web/index.html`ä¸­æ·»åŠ åœ°å›¾å®¹å™¨ï¼š

```html
<div id="map-container" style="width: 100%; height: 100vh;"></div>
```

### 2. åˆå§‹åŒ–é«˜å¾·åœ°å›¾

åˆ›å»ºDartä¸JavaScriptçš„äº’æ“ä½œä»£ç ï¼š

```dart
// lib/amap_web_api.dart
@JS()
library amap_web_api;

import 'package:js/js.dart';
import 'package:js/js_util.dart';

@JS('AMap')
class AMap {
  external static Map create(String containerId, MapOptions options);
}

@JS()
@anonymous
class MapOptions {
  external factory MapOptions({
    int zoom,
    double centerLng,
    double centerLat,
    bool zoomEnable,
    bool dragEnable,
    bool resizeEnable,
  });
}

@JS()
class Marker {
  external factory Marker(MarkerOptions options);
  external void addTo(Map map);
  external void remove();
  external void on(String eventName, Function callback);
  external void setPosition(LngLat position);
  external void setContent(String content);
}

@JS()
@anonymous
class MarkerOptions {
  external factory MarkerOptions({
    LngLat position,
    String content,
    bool bubble,
    bool cursor,
    bool draggable,
    bool raiseOnDrag,
    bool visible,
    int zIndex,
  });
}

@JS()
class LngLat {
  external factory LngLat(double lng, double lat);
}

@JS()
class InfoWindow {
  external factory InfoWindow(InfoWindowOptions options);
  external void open(Map map, LngLat position);
}

@JS()
@anonymous
class InfoWindowOptions {
  external factory InfoWindowOptions({
    String content,
    int offset,
    bool autoMove,
    bool closeWhenClickMap,
  });
}

// è·¯çº¿è§„åˆ’ç›¸å…³
@JS()
class Driving {
  external factory Driving(DrivingOptions options);
  external void search(LngLat start, LngLat end, [Function callback]);
}

@JS()
@anonymous
class DrivingOptions {
  external factory DrivingOptions({
    bool map,
    bool panel,
    bool policy,
    bool hideMarkers,
    bool showTraffic,
    double zIndex,
  });
}

@JS()
class Transit {
  external factory Transit(TransitOptions options);
  external void search(LngLat start, LngLat end, [Function callback]);
}

@JS()
@anonymous
class TransitOptions {
  external factory TransitOptions({
    bool map,
    bool panel,
    bool policy,
    bool city,
    bool cityd,
    bool hideMarkers,
    double zIndex,
  });
}

// æœç´¢æœåŠ¡
@JS()
class PlaceSearch {
  external factory PlaceSearch(PlaceSearchOptions options);
  external void search(String keyword, Function callback);
  external void searchNearBy(String keyword, LngLat center, double radius, Function callback);
}

@JS()
@anonymous
class PlaceSearchOptions {
  external factory PlaceSearchOptions({
    String city,
    int pageSize,
    int pageIndex,
    String type,
    bool map,
    bool panel,
    bool cityLimit,
  });
}

// åˆå§‹åŒ–åœ°å›¾
void initMap() {
  js.context.callMethod('initAmap', [AMAP_API_KEY]);
}

// Dartç«¯è°ƒç”¨
void initializeMap() {
  initMap();
}
```

### 3. åˆ›å»ºJavaScriptæ¡¥æ¥æ–‡ä»¶

åœ¨ `web/js/amap_bridge.js`ä¸­æ·»åŠ ï¼š

```javascript
function initAmap(apiKey) {
  // åŠ è½½é«˜å¾·åœ°å›¾JS API
  const script = document.createElement('script');
  script.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}`;
  script.onload = function() {
    // åˆå§‹åŒ–åœ°å›¾
    window.map = new AMap.Map('map-container', {
      zoom: 13,
      center: [116.397428, 39.90923],
      zoomEnable: true,
      dragEnable: true,
      resizeEnable: true
    });
  
    // å­˜å‚¨æ ‡è®°ç‚¹
    window.markers = [];
    window.routes = [];
  
    console.log('é«˜å¾·åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
  };
  document.head.appendChild(script);
}

// åˆ›å»ºæ ‡è®°ç‚¹
function createMarker(lng, lat, content, clickable = true) {
  const marker = new AMap.Marker({
    position: new AMap.LngLat(lng, lat),
    content: content || '<div style="width:20px;height:20px;background:red;border-radius:50%;"></div>',
    bubble: true,
    cursor: 'pointer',
    draggable: false,
    raiseOnDrag: false,
    visible: true,
    zIndex: 100
  });
  
  if (clickable) {
    marker.on('click', function(e) {
      const infoWindow = new AMap.InfoWindow({
        content: `<div style="padding:10px;">${content || 'ä½ç½®ä¿¡æ¯'}</div>`,
        offset: new AMap.Pixel(0, -30),
        autoMove: true,
        closeWhenClickMap: true
      });
      infoWindow.open(window.map, marker.getPosition());
    
      // é€šçŸ¥Dartç«¯æ ‡è®°ç‚¹è¢«ç‚¹å‡»
      if (window.onMarkerClick) {
        window.onMarkerClick({
          lng: lng,
          lat: lat,
          content: content
        });
      }
    });
  }
  
  marker.addTo(window.map);
  window.markers.push(marker);
  return marker;
}

// æ¸…é™¤æ‰€æœ‰æ ‡è®°ç‚¹
function clearMarkers() {
  window.markers.forEach(marker => marker.remove());
  window.markers = [];
}

// æ˜¾ç¤º/éšè—æ ‡è®°ç‚¹
function toggleMarkerVisibility(visible) {
  window.markers.forEach(marker => {
    marker.setOptions({ visible: visible });
  });
}

// åˆ›å»ºé©¾è½¦è·¯çº¿
function createDrivingRoute(startLng, startLat, endLng, endLat, showTraffic = true) {
  const driving = new AMap.Driving({
    map: window.map,
    panel: 'panel',
    policy: AMap.DrivingPolicy.LEAST_TIME,
    hideMarkers: false,
    showTraffic: showTraffic,
    zIndex: 10
  });
  
  const start = new AMap.LngLat(startLng, startLat);
  const end = new AMap.LngLat(endLng, endLat);
  
  driving.search(start, end, function(status, result) {
    if (status === 'complete') {
      // é€šçŸ¥Dartç«¯è·¯çº¿è§„åˆ’å®Œæˆ
      if (window.onRouteComplete) {
        window.onRouteComplete({
          status: 'success',
          distance: result.routes[0].distance,
          time: result.routes[0].time,
          tolls: result.routes[0].tolls
        });
      }
    } else {
      if (window.onRouteComplete) {
        window.onRouteComplete({
          status: 'error',
          message: result
        });
      }
    }
  });
  
  return driving;
}

// åˆ›å»ºå…¬äº¤è·¯çº¿
function createTransitRoute(startLng, startLat, endLng, endLat, city) {
  const transit = new AMap.Transit({
    map: window.map,
    panel: 'panel',
    policy: AMap.TransitPolicy.LEAST_TIME,
    city: city,
    hideMarkers: false,
    zIndex: 10
  });
  
  const start = new AMap.LngLat(startLng, startLat);
  const end = new AMap.LngLat(endLng, endLat);
  
  transit.search(start, end, function(status, result) {
    if (status === 'complete') {
      if (window.onRouteComplete) {
        window.onRouteComplete({
          status: 'success',
          distance: result.routes[0].distance,
          time: result.routes[0].time,
          price: result.routes[0].price
        });
      }
    } else {
      if (window.onRouteComplete) {
        window.onRouteComplete({
          status: 'error',
          message: result
        });
      }
    }
  });
  
  return transit;
}

// åœ°ç‚¹æœç´¢ï¼ˆå…³é”®å­—æœç´¢ï¼‰
function searchPlaces(keyword, city, callback) {
  const placeSearch = new AMap.PlaceSearch({
    city: city || 'å…¨å›½',
    pageSize: 20,
    pageIndex: 1,
    map: window.map,
    panel: 'panel',
    citylimit: true
  });
  
  placeSearch.search(keyword, function(status, result) {
    if (status === 'complete') {
      const pois = result.poiList.pois.map(poi => ({
        id: poi.id,
        name: poi.name,
        address: poi.address,
        location: {
          lng: poi.location.lng,
          lat: poi.location.lat
        },
        type: poi.type
      }));
    
      callback({ status: 'success', results: pois });
    } else {
      callback({ status: 'error', message: result });
    }
  });
}

// å‘¨è¾¹æœç´¢
function searchNearby(keyword, centerLng, centerLat, radius, callback) {
  const placeSearch = new AMap.PlaceSearch({
    pageSize: 20,
    pageIndex: 1,
    map: window.map,
    panel: 'panel'
  });
  
  const center = new AMap.LngLat(centerLng, centerLat);
  
  placeSearch.searchNearBy(keyword, center, radius, function(status, result) {
    if (status === 'complete') {
      const pois = result.poiList.pois.map(poi => ({
        id: poi.id,
        name: poi.name,
        address: poi.address,
        location: {
          lng: poi.location.lng,
          lat: poi.location.lat
        },
        type: poi.type,
        distance: poi.distance
      }));
    
      callback({ status: 'success', results: pois });
    } else {
      callback({ status: 'error', message: result });
    }
  });
}
```

### 4. åœ¨Flutterä¸­åˆå§‹åŒ–åœ°å›¾

```dart
import 'dart:js' as js;
import 'package:js/js_util.dart';
import 'package:flutter/material.dart';

class MapPage extends StatefulWidget {
  @override
  _MapPageState createState() => _MapPageState();
}

class _MapPageState extends State<MapPage> {
  // æ ‡è®°ç‚¹åˆ—è¡¨
  List<Map<String, dynamic>> markers = [];
  
  @override
  void initState() {
    super.initState();
    // åˆå§‹åŒ–åœ°å›¾
    initializeMap();
    // è®¾ç½®JavaScriptå›è°ƒ
    setupJsCallbacks();
  }
  
  void initializeMap() {
    js.context.callMethod('initAmap', [AMAP_API_KEY]);
  }
  
  void setupJsCallbacks() {
    // è®¾ç½®æ ‡è®°ç‚¹ç‚¹å‡»å›è°ƒ
    js.context['onMarkerClick'] = allowInterop((data) {
      setState(() {
        print('æ ‡è®°ç‚¹è¢«ç‚¹å‡»: ${data['content']}');
        // å¤„ç†æ ‡è®°ç‚¹ç‚¹å‡»äº‹ä»¶
      });
    });
  
    // è®¾ç½®è·¯çº¿è§„åˆ’å®Œæˆå›è°ƒ
    js.context['onRouteComplete'] = allowInterop((data) {
      setState(() {
        if (data['status'] == 'success') {
          print('è·¯çº¿è§„åˆ’æˆåŠŸ');
          print('è·ç¦»: ${data['distance']}ç±³');
          print('æ—¶é—´: ${data['time']}ç§’');
          if (data.containsKey('price')) {
            print('ç¥¨ä»·: ${data['price']}å…ƒ');
          }
          if (data.containsKey('tolls')) {
            print('è¿‡è·¯è´¹: ${data['tolls']}å…ƒ');
          }
        } else {
          print('è·¯çº¿è§„åˆ’å¤±è´¥: ${data['message']}');
        }
      });
    });
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        width: double.infinity,
        height: double.infinity,
        child: Stack(
          children: [
            // åœ°å›¾å®¹å™¨
            HtmlElementView(viewType: 'map-container'),
            // æ§åˆ¶é¢æ¿
            Positioned(
              bottom: 20,
              left: 20,
              right: 20,
              child: Container(
                padding: EdgeInsets.all(10),
                color: Colors.white.withOpacity(0.8),
                child: Column(
                  children: [
                    Row(
                      children: [
                        ElevatedButton(
                          onPressed: () => addTestMarkers(),
                          child: Text('æ·»åŠ æµ‹è¯•æ ‡è®°ç‚¹'),
                        ),
                        SizedBox(width: 10),
                        ElevatedButton(
                          onPressed: () => clearAllMarkers(),
                          child: Text('æ¸…é™¤æ‰€æœ‰æ ‡è®°ç‚¹'),
                        ),
                        SizedBox(width: 10),
                        ElevatedButton(
                          onPressed: () => toggleMarkersVisibility(),
                          child: Text('åˆ‡æ¢æ ‡è®°ç‚¹æ˜¾ç¤º'),
                        ),
                      ],
                    ),
                    SizedBox(height: 10),
                    Row(
                      children: [
                        ElevatedButton(
                          onPressed: () => planDrivingRoute(),
                          child: Text('é©¾è½¦å¯¼èˆª'),
                        ),
                        SizedBox(width: 10),
                        ElevatedButton(
                          onPressed: () => planTransitRoute(),
                          child: Text('å…¬äº¤å¯¼èˆª'),
                        ),
                      ],
                    ),
                    SizedBox(height: 10),
                    TextField(
                      decoration: InputDecoration(
                        hintText: 'æœç´¢åœ°ç‚¹',
                        prefixIcon: Icon(Icons.search),
                      ),
                      onSubmitted: (value) => searchPlaces(value),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
  
  void addTestMarkers() {
    // æ·»åŠ æµ‹è¯•æ ‡è®°ç‚¹
    final testPoints = [
      {'lng': 116.397428, 'lat': 39.90923, 'name': 'å¤©å®‰é—¨'},
      {'lng': 116.407395, 'lat': 39.904211, 'name': 'ç‹åºœäº•'},
      {'lng': 116.388878, 'lat': 39.914602, 'name': 'è¥¿å•'},
    ];
  
    markers = testPoints;
  
    for (var point in testPoints) {
      js.context.callMethod('createMarker', [
        point['lng'],
        point['lat'],
        point['name'],
        true
      ]);
    }
  }
  
  void clearAllMarkers() {
    markers.clear();
    js.context.callMethod('clearMarkers', []);
  }
  
  void toggleMarkersVisibility() {
    final isVisible = markers.isNotEmpty && markers.first['visible'] != false;
    for (var marker in markers) {
      marker['visible'] = !isVisible;
    }
    js.context.callMethod('toggleMarkerVisibility', [!isVisible]);
  }
  
  void planDrivingRoute() {
    if (markers.length >= 2) {
      final start = markers[0];
      final end = markers[1];
      js.context.callMethod('createDrivingRoute', [
        start['lng'], start['lat'],
        end['lng'], end['lat'],
        true
      ]);
    } else {
      print('è¯·å…ˆæ·»åŠ è‡³å°‘2ä¸ªæ ‡è®°ç‚¹');
    }
  }
  
  void planTransitRoute() {
    if (markers.length >= 2) {
      final start = markers[0];
      final end = markers[1];
      js.context.callMethod('createTransitRoute', [
        start['lng'], start['lat'],
        end['lng'], end['lat'],
        'åŒ—äº¬'
      ]);
    } else {
      print('è¯·å…ˆæ·»åŠ è‡³å°‘2ä¸ªæ ‡è®°ç‚¹');
    }
  }
  
  void searchPlaces(String keyword) {
    js.context.callMethod('searchPlaces', [keyword, 'åŒ—äº¬', allowInterop((result) {
      if (result['status'] == 'success') {
        setState(() {
          markers = result['results'].map((poi) => {
            'id': poi['id'],
            'name': poi['name'],
            'address': poi['address'],
            'lng': poi['location']['lng'],
            'lat': poi['location']['lat'],
            'type': poi['type'],
            'visible': true
          }).toList();
        
          // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæœç´¢ç»“æœ
          for (var poi in result['results']) {
            js.context.callMethod('createMarker', [
              poi['location']['lng'],
              poi['location']['lat'],
              poi['name'],
              true
            ]);
          }
        });
      } else {
        print('æœç´¢å¤±è´¥: ${result['message']}');
      }
    })]);
  }
}
```

## ä¸‰ã€å…·ä½“åŠŸèƒ½å®ç°

### 1. åœ°ç‚¹æœç´¢åŠŸèƒ½

```dart
// æ ¹æ®åœ°ç‚¹åç§°ã€åŸå¸‚åç§°æœç´¢
Future<List<Map<String, dynamic>>> searchLocation({
  required String keyword,
  String? city,
  String? country,
}) async {
  final completer = Completer<List<Map<String, dynamic>>>();
  
  js.context.callMethod('searchPlaces', [
    keyword,
    city ?? 'å…¨å›½',
    allowInterop((result) {
      if (result['status'] == 'success') {
        completer.complete(result['results']);
      } else {
        completer.completeError(result['message']);
      }
    })
  ]);
  
  return completer.future;
}

// å‘¨è¾¹æœç´¢ï¼ˆæ ¹æ®ä¸­å¿ƒç‚¹å’ŒåŠå¾„ï¼‰
Future<List<Map<String, dynamic>>> searchNearby({
  required String keyword,
  required double centerLng,
  required double centerLat,
  double radius = 1000, // 1å…¬é‡Œ
}) async {
  final completer = Completer<List<Map<String, dynamic>>>();
  
  js.context.callMethod('searchNearby', [
    keyword,
    centerLng,
    centerLat,
    radius,
    allowInterop((result) {
      if (result['status'] == 'success') {
        completer.complete(result['results']);
      } else {
        completer.completeError(result['message']);
      }
    })
  ]);
  
  return completer.future;
}
```

### 2. åœ°å›¾æ ‡è®°ç‚¹ç®¡ç†

```dart
// æ·»åŠ æ ‡è®°ç‚¹
void addMarker({
  required double lng,
  required double lat,
  String? content,
  bool clickable = true,
  bool visible = true,
}) {
  js.context.callMethod('createMarker', [
    lng,
    lat,
    content ?? '<div style="width:20px;height:20px;background:red;border-radius:50%;"></div>',
    clickable
  ]);
  
  markers.add({
    'lng': lng,
    'lat': lat,
    'content': content,
    'visible': visible
  });
}

// æ¸…é™¤æ‰€æœ‰æ ‡è®°ç‚¹
void clearAllMarkers() {
  js.context.callMethod('clearMarkers', []);
  markers.clear();
}

// è°ƒæ•´æ ‡è®°ç‚¹æ˜¾ç¤º
void setMarkerVisibility(bool visible) {
  js.context.callMethod('toggleMarkerVisibility', [visible]);
  for (var marker in markers) {
    marker['visible'] = visible;
  }
}

// è‡ªå®šä¹‰æ ‡è®°ç‚¹æ ·å¼
void customizeMarkerStyle({
  required int index,
  String? content,
  String? color,
  double? size,
}) {
  if (index < markers.length) {
    final marker = markers[index];
    final newContent = content ?? 
      '<div style="width:${size ?? 20}px;height:${size ?? 20}px;background:${color ?? 'red'};border-radius:50%;"></div>';
  
    // éœ€è¦é‡æ–°åˆ›å»ºæ ‡è®°ç‚¹ï¼Œé«˜å¾·JS APIä¸æ”¯æŒç›´æ¥ä¿®æ”¹æ ·å¼
    js.context.callMethod('clearMarkers', []);
    markers.forEach((m) {
      js.context.callMethod('createMarker', [
        m['lng'],
        m['lat'],
        m == marker ? newContent : m['content'],
        true
      ]);
    });
  }
}
```

### 3. è·¯çº¿è§„åˆ’ä¸å¯¼èˆª

```dart
// é©¾è½¦è·¯çº¿è§„åˆ’
Future<Map<String, dynamic>> planDrivingRoute({
  required List<Map<String, dynamic>> waypoints,
  bool showTraffic = true,
}) async {
  if (waypoints.length < 2) {
    throw Exception('è‡³å°‘éœ€è¦2ä¸ªé€”ç»ç‚¹');
  }
  
  final completer = Completer<Map<String, dynamic>>();
  
  // é«˜å¾·JS APIçš„Drivingæ”¯æŒå¤šä¸ªé€”ç»ç‚¹
  js.context.callMethod('createDrivingRouteWithWaypoints', [
    waypoints.map((w) => w['lng']).toList(),
    waypoints.map((w) => w['lat']).toList(),
    showTraffic,
    allowInterop((result) {
      if (result['status'] == 'complete') {
        completer.complete({
          'status': 'success',
          'distance': result['routes'][0]['distance'],
          'time': result['routes'][0]['time'],
          'tolls': result['routes'][0]['tolls'],
          'steps': result['routes'][0]['steps']
        });
      } else {
        completer.completeError(result['message']);
      }
    })
  ]);
  
  return completer.future;
}

// å…¬å…±äº¤é€šè·¯çº¿è§„åˆ’
Future<Map<String, dynamic>> planTransitRoute({
  required Map<String, dynamic> start,
  required Map<String, dynamic> end,
  String city = 'åŒ—äº¬',
}) async {
  final completer = Completer<Map<String, dynamic>>();
  
  js.context.callMethod('createTransitRoute', [
    start['lng'],
    start['lat'],
    end['lng'],
    end['lat'],
    city,
    allowInterop((result) {
      if (result['status'] == 'complete') {
        completer.complete({
          'status': 'success',
          'distance': result['routes'][0]['distance'],
          'time': result['routes'][0]['time'],
          'price': result['routes'][0]['price'],
          'segments': result['routes'][0]['segments']
        });
      } else {
        completer.completeError(result['message']);
      }
    })
  ]);
  
  return completer.future;
}

// å¤šç‚¹è·¯çº¿è§„åˆ’ï¼ˆæ»¡è¶³é¡ºåºè¦æ±‚ï¼‰
Future<Map<String, dynamic>> planSequentialRoute({
  required List<Map<String, dynamic>> points,
  String transportMode = 'driving', // driving, transit, walking
}) async {
  if (points.length < 2) {
    throw Exception('è‡³å°‘éœ€è¦2ä¸ªç‚¹');
  }
  
  final results = <Map<String, dynamic>>[];
  double totalDistance = 0;
  double totalTime = 0;
  
  for (var i = 0; i < points.length - 1; i++) {
    final start = points[i];
    final end = points[i + 1];
  
    if (transportMode == 'driving') {
      final result = await planDrivingRoute(
        waypoints: [start, end],
        showTraffic: true
      );
      results.add(result);
      totalDistance += result['distance'];
      totalTime += result['time'];
    } else if (transportMode == 'transit') {
      final result = await planTransitRoute(
        start: start,
        end: end,
        city: 'åŒ—äº¬'
      );
      results.add(result);
      totalDistance += result['distance'];
      totalTime += result['time'];
    }
  }
  
  return {
    'status': 'success',
    'total_distance': totalDistance,
    'total_time': totalTime,
    'segments': results
  };
}
```

### 4. äº‹ä»¶å¤„ç†

```dart
// å¤„ç†åœ°å›¾ç‚¹å‡»äº‹ä»¶
void setupMapClickHandler() {
  js.context['onMapClick'] = allowInterop((data) {
    setState(() {
      print('åœ°å›¾è¢«ç‚¹å‡»ä½ç½®: ${data['lng']}, ${data['lat']}');
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ ‡è®°ç‚¹æˆ–æ‰§è¡Œå…¶ä»–æ“ä½œ
    });
  });
}

// å¤„ç†æ ‡è®°ç‚¹ç‚¹å‡»äº‹ä»¶
void setupMarkerClickHandler(Function(Map<String, dynamic>) callback) {
  js.context['onMarkerClick'] = allowInterop((data) {
    callback({
      'lng': data['lng'],
      'lat': data['lat'],
      'content': data['content']
    });
  });
}

// å¤„ç†è·¯çº¿è§„åˆ’å®Œæˆäº‹ä»¶
void setupRouteCompleteHandler(Function(Map<String, dynamic>) callback) {
  js.context['onRouteComplete'] = allowInterop((data) {
    callback(data);
  });
}
```

## å››ã€é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

### 1. æ— æ³•å®Œå…¨å®ç°çš„åŠŸèƒ½

- **é«˜å¾·åœ°å›¾Flutter Web SDK**ï¼šé«˜å¾·å®˜æ–¹æ²¡æœ‰æä¾›ä¸“é—¨çš„Flutter Web SDKï¼Œéœ€è¦é€šè¿‡JavaScript APIæ¡¥æ¥å®ç°
- **å®æ—¶äº¤é€šæ•°æ®**ï¼šåœ¨Webç«¯è·å–å®æ—¶äº¤é€šæ•°æ®éœ€è¦é¢å¤–çš„APIè°ƒç”¨å’Œæƒé™
- **ç¦»çº¿åœ°å›¾**ï¼šFlutter Webæ— æ³•å®ç°ç¦»çº¿åœ°å›¾åŠŸèƒ½
- **3Dåœ°å›¾**ï¼šWebç«¯çš„3Dåœ°å›¾åŠŸèƒ½æœ‰é™ï¼Œä¸å¦‚åŸç”ŸSDKå¼ºå¤§

### 2. é«˜å¾·åœ°å›¾APIé™åˆ¶

- **è°ƒç”¨é¢‘ç‡é™åˆ¶**ï¼šå…è´¹ç‰ˆæœ‰è°ƒç”¨æ¬¡æ•°é™åˆ¶ï¼Œéœ€è¦ç”³è¯·ä¼ä¸šç‰ˆè·å–æ›´é«˜é…é¢
- **å¹¶å‘é™åˆ¶**ï¼šåŒä¸€æ—¶é—´åªèƒ½è§„åˆ’ä¸€æ¡è·¯çº¿
- **è·¨åŸŸé—®é¢˜**ï¼šåœ¨Webç¯å¢ƒä¸‹éœ€è¦æ³¨æ„CORSé—®é¢˜

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®

```dart
// 1. æ‡’åŠ è½½åœ°å›¾
void loadMapWhenNeeded() {
  if (!isMapLoaded) {
    initializeMap();
    isMapLoaded = true;
  }
}

// 2. æ‰¹é‡æ“ä½œæ ‡è®°ç‚¹
void batchUpdateMarkers(List<Map<String, dynamic>> newMarkers) {
  js.context.callMethod('clearMarkers', []);
  for (var marker in newMarkers) {
    js.context.callMethod('createMarker', [
      marker['lng'],
      marker['lat'],
      marker['content'],
      true
    ]);
  }
  markers = newMarkers;
}

// 3. ä½¿ç”¨èŠ‚æµå‡½æ•°
void throttleSearch(String keyword) {
  if (_searchTimer != null) {
    _searchTimer!.cancel();
  }
  
  _searchTimer = Timer(const Duration(milliseconds: 300), () {
    searchPlaces(keyword);
  });
}
```

## äº”ã€å®Œæ•´ç¤ºä¾‹ä»£ç 

```dart
import 'dart:async';
import 'dart:js' as js;
import 'package:flutter/material.dart';
import 'package:js/js.dart';
import 'package:js/js_util.dart';

const String AMAP_API_KEY = 'YOUR_AMAP_API_KEY';

void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'é«˜å¾·åœ°å›¾Flutter Web Demo',
      theme: ThemeData(
        primarySwatch: Colors.blue,
      ),
      home: MapPage(),
    );
  }
}

// ä»¥ä¸‹æ˜¯å®Œæ•´çš„MapPageç±»å®ç°ï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½
// ...ï¼ˆä¸Šé¢å·²ç»å±•ç¤ºçš„éƒ¨åˆ†ä»£ç ï¼‰
```

## å…­ã€æ€»ç»“

é€šè¿‡ä»¥ä¸Šå®ç°ï¼Œæ‚¨å¯ä»¥åœ¨Flutter Webåº”ç”¨ä¸­å®Œæ•´ä½¿ç”¨é«˜å¾·åœ°å›¾APIçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- âœ… æ ¹æ®åœ°ç‚¹åç§°ã€åŸå¸‚åç§°æœç´¢åœ°ç‚¹
- âœ… åœ¨Flutter Webä¸Šå±•ç¤ºåœ°å›¾
- âœ… åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå¯ç‚¹å‡»çš„åœ°ç‚¹
- âœ… è·å–ç”¨æˆ·ç‚¹å‡»é€‰æ‹©çš„åœ°ç‚¹
- âœ… è°ƒæ•´åœ°å›¾ä¸Šç‚¹çš„æ˜¾ç¤ºä¸å¦å’Œæ˜¾ç¤ºæ–¹å¼
- âœ… æ ¹æ®äº¤é€šæ–¹å¼å’Œåœ°ç‚¹åˆ—è¡¨è¿›è¡Œå¯¼èˆªè§„åˆ’
- âœ… è·å–å¯¼èˆªé¢„è®¡æ—¶é—´å¼€é”€
- âœ… åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå¯¼èˆªè·¯çº¿

**æ— æ³•å®Œå…¨å®ç°çš„åŠŸèƒ½**ï¼š

- é«˜å¾·å®˜æ–¹æ²¡æœ‰æä¾›çº¯Web APIçš„å¯¼èˆªè·¯çº¿ç»˜åˆ¶åŠŸèƒ½ï¼Œéœ€è¦ä¾èµ–JavaScript API
- å…¬å…±äº¤é€šçš„è¯¦ç»†æ¢ä¹˜ä¿¡æ¯åœ¨å…è´¹ç‰ˆä¸­å¯èƒ½æœ‰é™åˆ¶
- å®æ—¶äº¤é€šæ•°æ®çš„è·å–éœ€è¦ä¼ä¸šçº§æƒé™

å»ºè®®åœ¨å®é™…é¡¹ç›®ä¸­ï¼š

1. ç”³è¯·ä¼ä¸šçº§é«˜å¾·åœ°å›¾API Keyè·å–æ›´é«˜é…é¢
2. å®ç°é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–
3. è€ƒè™‘ä½¿ç”¨ç¼“å­˜å‡å°‘APIè°ƒç”¨æ¬¡æ•°
4. é’ˆå¯¹ä¸åŒè®¾å¤‡è¿›è¡Œå“åº”å¼è®¾è®¡ä¼˜åŒ–

è¿™ä»½æ–‡æ¡£æä¾›äº†å®Œæ•´çš„ä»£ç å®ç°å’Œè¯¦ç»†è¯´æ˜ï¼Œæ‚¨å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´å’Œæ‰©å±•ã€‚

---



# ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«

## ä¸€ã€å‡†å¤‡å·¥ä½œ

### 1. æ³¨å†Œç§‘å¤§è®¯é£è´¦å·

- è®¿é—®ç§‘å¤§è®¯é£å¼€æ”¾å¹³å°ï¼ˆhttps://www.xfyun.cn/ï¼‰æ³¨å†Œè´¦å·
- åˆ›å»ºåº”ç”¨å¹¶è·å–APPIDã€APISecretã€APIKeyç­‰è®¤è¯ä¿¡æ¯

### 2. äº†è§£APIç‰¹æ€§

- ç§‘å¤§è®¯é£è¯­éŸ³å¬å†™ï¼ˆæµå¼ç‰ˆï¼‰WebAPIæ”¯æŒ1åˆ†é’Ÿå†…çš„å³æ—¶è¯­éŸ³è½¬æ–‡å­—æŠ€æœ¯
- è¯¥æ¥å£é€šè¿‡WebSocket APIæ–¹å¼æä¾›æœåŠ¡ï¼Œæ”¯æŒå®æ—¶è¿”å›è¯†åˆ«ç»“æœ
- å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://www.xfyun.cn/doc/asr/voicedictation/API.html

## äºŒã€Flutteré¡¹ç›®é…ç½®

### 1. æ·»åŠ ä¾èµ–

åœ¨ `pubspec.yaml`æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š

```yaml
dependencies:
  ifly_speech_recognition: ^1.0.5  # åŸºäºç§‘å¤§è®¯é£è¯­éŸ³å¬å†™WebAPIçš„Flutteræ’ä»¶ 
  flutter_sound: ^9.2.3  # ç”¨äºå½•éŸ³åŠŸèƒ½ 
  web_socket_channel: ^2.1.0  # WebSocketé€šä¿¡
```

### 2. Webé¡¹ç›®ç‰¹æ®Šé…ç½®

åœ¨ `web/index.html`ä¸­æ·»åŠ å¿…è¦çš„æƒé™å’Œé…ç½®ï¼š

```html
<script>
  // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒå½•éŸ³
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    console.log('æµè§ˆå™¨æ”¯æŒå½•éŸ³åŠŸèƒ½');
  } else {
    console.warn('æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½');
  }
</script>
```

## ä¸‰ã€APIé›†æˆå®ç°

### 1. åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«æœåŠ¡

```dart
import 'package:ifly_speech_recognition/ifly_speech_recognition.dart';

class SpeechRecognitionService {
  final String appId;
  final String apiSecret;
  final String apiKey;
  
  SpeechRecognitionService({
    required this.appId,
    required this.apiSecret,
    required this.apiKey,
  });

  Future<void> init() async {
    // åˆå§‹åŒ–ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«
    await IflySpeechRecognition.init(
      appId: appId,
      apiSecret: apiSecret,
      apiKey: apiKey,
    );
  }
}
```

### 2. å½•éŸ³å’Œè¯†åˆ«å®ç°

```dart
import 'package:flutter_sound/flutter_sound.dart';
import 'dart:convert';
import 'package:web_socket_channel/web_socket_channel.dart';

class VoiceRecognizer {
  FlutterSoundRecorder? _recorder;
  WebSocketChannel? _channel;
  bool _isRecording = false;
  
  Future<void> startRecording() async {
    // åˆå§‹åŒ–å½•éŸ³å™¨
    _recorder = FlutterSoundRecorder();
    await _recorder!.openRecorder();
  
    // è¿æ¥WebSocket
    _channel = WebSocketChannel.connect(
      Uri.parse('wss://ws-api.xfyun.cn/v2/iat'),
    );
  
    // å¼€å§‹å½•éŸ³
    await _recorder!.startRecorder(
      toFile: 'temp_recording.pcm',
      codec: Codec.pcm16,
      sampleRate: 16000,
    );
  
    _isRecording = true;
  
    // å®šæ—¶å‘é€éŸ³é¢‘æ•°æ®
    _sendAudioData();
  }
  
  void _sendAudioData() {
    // è¿™é‡Œéœ€è¦å®ç°éŸ³é¢‘æ•°æ®è¯»å–å’Œå‘é€é€»è¾‘
    // å‚è€ƒç§‘å¤§è®¯é£WebAPIæ–‡æ¡£çš„éŸ³é¢‘æ ¼å¼è¦æ±‚ 
  }
  
  Future<void> stopRecording() async {
    if (_isRecording) {
      await _recorder!.stopRecorder();
      await _channel!.sink.close();
      _isRecording = false;
    }
  }
}
```

## å››ã€å®Œæ•´ç¤ºä¾‹ä»£ç 

### 1. ä¸»è¦ä¸šåŠ¡é€»è¾‘

```dart
class SpeechRecognitionPage extends StatefulWidget {
  @override
  _SpeechRecognitionPageState createState() => _SpeechRecognitionPageState();
}

class _SpeechRecognitionPageState extends State<SpeechRecognitionPage> {
  String _resultText = '';
  bool _isListening = false;
  final SpeechRecognitionService _speechService = 
      SpeechRecognitionService(
        appId: 'YOUR_APP_ID',
        apiSecret: 'YOUR_API_SECRET', 
        apiKey: 'YOUR_API_KEY',
      );

  @override
  void initState() {
    super.initState();
    _initSpeechService();
  }

  Future<void> _initSpeechService() async {
    try {
      await _speechService.init();
    } catch (e) {
      print('åˆå§‹åŒ–å¤±è´¥: $e');
    }
  }

  Future<void> _startListening() async {
    try {
      setState(() {
        _isListening = true;
        _resultText = 'æ­£åœ¨è†å¬...';
      });
    
      // å¼€å§‹è¯­éŸ³è¯†åˆ«
      final result = await IflySpeechRecognition.startListening(
        timeout: 60, // 60ç§’è¶…æ—¶ 
        language: 'zh_cn', // ä¸­æ–‡
        accent: 'mandarin', // æ™®é€šè¯
      );
    
      setState(() {
        _resultText = result ?? 'è¯†åˆ«å¤±è´¥';
        _isListening = false;
      });
    } catch (e) {
      setState(() {
        _resultText = 'é”™è¯¯: $e';
        _isListening = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('è¯­éŸ³è¯†åˆ«')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(
              _resultText,
              style: TextStyle(fontSize: 20),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: 40),
            ElevatedButton(
              onPressed: _isListening ? null : _startListening,
              child: Text(_isListening ? 'è†å¬ä¸­...' : 'å¼€å§‹è¯´è¯'),
              style: ElevatedButton.styleFrom(
                minimumSize: Size(200, 60),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

## äº”ã€æ³¨æ„äº‹é¡¹

### 1. å¹³å°å…¼å®¹æ€§

- `ifly_speech_recognition`æ’ä»¶ä¸»è¦æ”¯æŒç§»åŠ¨ç«¯ï¼ŒWebç«¯éœ€è¦é¢å¤–å¤„ç†æµè§ˆå™¨å…¼å®¹æ€§
- Webç«¯éœ€è¦ç¡®ä¿æµè§ˆå™¨æ”¯æŒWeb Audio APIå’ŒWebSocket

### 2. éŸ³é¢‘æ ¼å¼è¦æ±‚

- é‡‡æ ·ç‡å¿…é¡»ä¸º16000Hz
- éŸ³é¢‘æ ¼å¼é€šå¸¸ä¸ºPCMæˆ–WAVæ ¼å¼
- å•æ¬¡è¯†åˆ«æ—¶é•¿ä¸è¶…è¿‡60ç§’

### 3. æƒé™å¤„ç†

- Webç«¯éœ€è¦ç”¨æˆ·æˆæƒéº¦å…‹é£æƒé™
- åœ¨Flutter webä¸­ï¼Œéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶è¯·æ±‚æƒé™

### 4. é”™è¯¯å¤„ç†

- ç½‘ç»œè¿æ¥ä¸­æ–­å¤„ç†
- éŸ³é¢‘æ•°æ®æ ¼å¼é”™è¯¯å¤„ç†
- APIè°ƒç”¨é¢‘ç‡é™åˆ¶å¤„ç†

## å…­ã€å‚è€ƒèµ„æº

1. **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://www.xfyun.cn/doc/asr/voicedictation/API.html
2. **Flutterç¤ºä¾‹é¡¹ç›®**ï¼šhttps://github.com/xiaobug0929/xf_demo
3. **WebSocketé›†æˆç¤ºä¾‹**ï¼šå‚è€ƒç§‘å¤§è®¯é£WebAPIç¤ºä¾‹demo
4. **Flutteræ’ä»¶æ–‡æ¡£**ï¼šhttps://pub.dev/packages/ifly_speech_recognition

## ä¸ƒã€è°ƒè¯•å»ºè®®

1. **å…ˆåœ¨ç§»åŠ¨ç«¯æµ‹è¯•**ï¼šç¡®ä¿åŸºç¡€åŠŸèƒ½æ­£å¸¸å·¥ä½œ
2. **ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·**ï¼šç›‘æ§WebSocketè¿æ¥å’ŒéŸ³é¢‘æ•°æ®
3. **åˆ†æ­¥è°ƒè¯•**ï¼šå…ˆæµ‹è¯•å½•éŸ³åŠŸèƒ½ï¼Œå†æµ‹è¯•WebSocketè¿æ¥ï¼Œæœ€åæµ‹è¯•å®Œæ•´è¯†åˆ«æµç¨‹
4. **æŸ¥çœ‹APIè¿”å›çŠ¶æ€ç **ï¼šæ ¹æ®ç§‘å¤§è®¯é£æ–‡æ¡£ä¸­çš„é”™è¯¯ç è¿›è¡Œé—®é¢˜å®šä½

è¿™ä»½è¯´æ˜æ¶µç›–äº†åœ¨Flutter webé¡µé¢ä¸Šé›†æˆç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«APIçš„ä¸»è¦æ­¥éª¤å’Œæ³¨æ„äº‹é¡¹ã€‚å»ºè®®æ‚¨å…ˆå‚è€ƒå®˜æ–¹æ–‡æ¡£å’Œç¤ºä¾‹é¡¹ç›®ï¼Œæ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚

# æ™ºè°±ï¼ˆGLMï¼‰æœç´¢APIä½¿ç”¨è¯´æ˜ - Flutter Webé›†æˆ

## 1. æ¦‚è¿°

æ™ºè°±AIå¼€æ”¾å¹³å°æä¾›äº†Web Search APIï¼Œè¿™æ˜¯ä¸€ä¸ªä¸“ä¸ºå¤§æ¨¡å‹è®¾è®¡çš„æœç´¢å¼•æ“ï¼Œåœ¨ä¼ ç»Ÿæœç´¢å¼•æ“ç½‘é¡µæŠ“å–ã€æ’åºçš„èƒ½åŠ›åŸºç¡€ä¸Šï¼Œå¢å¼ºäº†æ„å›¾è¯†åˆ«èƒ½åŠ›ï¼Œè¿”å›æ›´é€‚åˆå¤§æ¨¡å‹å¤„ç†çš„ç»“æœï¼ˆç½‘é¡µæ ‡é¢˜ã€ç½‘é¡µURLã€ç½‘é¡µæ‘˜è¦ç­‰ï¼‰ã€‚

## 2. å‡†å¤‡å·¥ä½œ

### 2.1 æ³¨å†Œè´¦å·å’Œè·å–API Key

1. è®¿é—®æ™ºè°±AIå¼€æ”¾å¹³å°å®˜ç½‘ï¼šhttps://bigmodel.cn
2. ç‚¹å‡»å³ä¸Šè§’çš„ã€Œæ³¨å†Œ/ç™»å½•ã€å®Œæˆè´¦å·æ³¨å†Œ
3. ç™»å½•åè¿›å…¥ã€Œä¸ªäººä¸­å¿ƒã€-ã€Œé¡¹ç›®ç®¡ç†ã€-ã€ŒAPI keysã€
4. ç‚¹å‡»ã€Œæ·»åŠ æ–°çš„API Keyã€ï¼Œç„¶åå¤åˆ¶ç”Ÿæˆçš„API Key

**æ³¨æ„**ï¼šä¸ºäº†å®‰å…¨èµ·è§ï¼Œå»ºè®®æ¯ä¸ªåº”ç”¨æˆ–é¡¹ç›®ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„API Keyï¼Œè€Œä¸æ˜¯å…±äº«ä¸€ä¸ªAPI Keyã€‚

### 2.2 å¥—é¤è¯´æ˜

- **ä»…Proã€Maxå¥—é¤æ”¯æŒ**ï¼šè§†è§‰ç†è§£ã€è”ç½‘æœç´¢MCPå·¥å…·
- **Liteå¥—é¤**ï¼šè°ƒç”¨è§†è§‰ç†è§£MCPéœ€è¦å•ç‹¬æ”¶è´¹ï¼Œä¸”æš‚æœªæ”¯æŒè°ƒç”¨æœç´¢å·¥å…·
- **æ–°ç”¨æˆ·ç¦åˆ©**ï¼šæ³¨å†Œå³å¯è·å¾—ä¸€å®šå…è´¹é¢åº¦çš„APIè°ƒç”¨èµ„æº

## 3. APIè°ƒç”¨åŸºç¡€

### 3.1 åŸºç¡€APIç«¯ç‚¹

```
POST https://open.bigmodel.cn/api/paas/v4/chat/completions
```

### 3.2 è¯·æ±‚å¤´è®¾ç½®

```dart
headers: {
  'Content-Type': 'application/json',
  'Authorization': 'Bearer YOUR_API_KEY'
}
```

### 3.3 åŸºç¡€è¯·æ±‚ä½“æ ¼å¼

```json
{
  "model": "glm-4",  // æˆ– glm-4.5, glm-4.5-air ç­‰
  "messages": [
    {
      "role": "user",
      "content": "ä½ çš„é—®é¢˜"
    }
  ],
  "tools": [
    {
      "type": "web_search",
      "web_search": {
        "enable": true,
        "search_query": "æœç´¢å…³é”®è¯"
      }
    }
  ]
}
```

## 4. Flutter Webé›†æˆç¤ºä¾‹

### 4.1 æ·»åŠ ä¾èµ–

åœ¨ `pubspec.yaml`ä¸­æ·»åŠ ï¼š

```yaml
dependencies:
  http: ^1.1.0
  convert: ^3.1.1
```

### 4.2 å®Œæ•´çš„Flutter Webç¤ºä¾‹ä»£ç 

```dart
import 'dart:convert';
import 'package:http/http.dart' as http;

class GLMApiService {
  final String apiKey;
  final String baseUrl = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
  
  GLMApiService(this.apiKey);

  Future<Map<String, dynamic>> searchWithGLM(String query) async {
    try {
      final response = await http.post(
        Uri.parse(baseUrl),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $apiKey',
        },
        body: json.encode({
          "model": "glm-4.5", // æ¨èä½¿ç”¨GLM-4.5ï¼Œå¯¹å·¥å…·è°ƒç”¨è¿›è¡Œäº†ä¼˜åŒ– 
          "messages": [
            {
              "role": "user",
              "content": query
            }
          ],
          "tools": [
            {
              "type": "web_search",
              "web_search": {
                "enable": true,
                "search_query": query
              }
            }
          ],
          "stream": false, // è®¾ç½®ä¸ºtrueå¯å¯ç”¨æµå¼è¾“å‡º
          "max_tokens": 1024,
          "temperature": 0.9
        }),
      );

      if (response.statusCode == 200) {
        return json.decode(response.body);
      } else {
        throw Exception('APIè¯·æ±‚å¤±è´¥: ${response.statusCode}, ${response.body}');
      }
    } catch (e) {
      throw Exception('è¯·æ±‚å¼‚å¸¸: $e');
    }
  }
}

// Flutter Widgetä½¿ç”¨ç¤ºä¾‹
import 'package:flutter/material.dart';

class SearchPage extends StatefulWidget {
  @override
  _SearchPageState createState() => _SearchPageState();
}

class _SearchPageState extends State<SearchPage> {
  final TextEditingController _controller = TextEditingController();
  String _result = '';
  bool _isLoading = false;
  
  // æ›¿æ¢ä¸ºä½ çš„å®é™…API Key
  final String _apiKey = 'your_api_key_here';
  final GLMApiService _apiService = GLMApiService('your_api_key_here');

  void _performSearch() async {
    setState(() {
      _isLoading = true;
      _result = '';
    });

    try {
      final result = await _apiService.searchWithGLM(_controller.text);
      // è§£æå“åº”ç»“æœ
      final content = result['choices'][0]['message']['content'];
      setState(() {
        _result = content;
      });
    } catch (e) {
      setState(() {
        _result = 'æœç´¢å¤±è´¥: $e';
      });
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('æ™ºè°±GLMæœç´¢'),
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            TextField(
              controller: _controller,
              decoration: InputDecoration(
                hintText: 'è¾“å…¥æœç´¢å†…å®¹...',
                suffixIcon: IconButton(
                  icon: Icon(Icons.search),
                  onPressed: _performSearch,
                ),
              ),
              onSubmitted: (_) => _performSearch(),
            ),
            SizedBox(height: 20),
            if (_isLoading)
              CircularProgressIndicator()
            else
              Expanded(
                child: SingleChildScrollView(
                  child: Text(
                    _result,
                    style: TextStyle(fontSize: 16),
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }
}
```

## 5. é«˜çº§åŠŸèƒ½å’Œé…ç½®

### 5.1 æµå¼è¾“å‡ºæ”¯æŒ

å¦‚æœéœ€è¦å®æ—¶æµå¼è¾“å‡ºï¼Œå¯ä»¥è®¾ç½® `"stream": true`ï¼Œå¹¶ä½¿ç”¨WebSocketæˆ–SSEï¼ˆServer-Sent Eventsï¼‰å¤„ç†æµå¼å“åº”ã€‚

### 5.2 å¤šè½®å¯¹è¯æ”¯æŒ

é€šè¿‡ç»´æŠ¤å¯¹è¯å†å²ï¼Œå¯ä»¥å®ç°å¤šè½®å¯¹è¯ï¼š

```dart
List<Map<String, dynamic>> _messages = [];

void addMessage(String role, String content) {
  _messages.add({
    "role": role,
    "content": content
  });
}

// è°ƒç”¨APIæ—¶ä½¿ç”¨
"messages": _messages
```

### 5.3 å·¥å…·è°ƒç”¨ä¼˜åŒ–

GLM-4.5å’ŒGLM-4.5-Airåœ¨å·¥å…·è°ƒç”¨ã€ç½‘é¡µæµè§ˆã€è½¯ä»¶å·¥ç¨‹ã€å‰ç«¯ç¼–ç¨‹é¢†åŸŸè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ¨èä½¿ç”¨è¿™äº›ç‰ˆæœ¬è·å¾—æ›´å¥½çš„æœç´¢ä½“éªŒã€‚

## 6. å“åº”æ ¼å¼è¯´æ˜

æˆåŠŸå“åº”ç¤ºä¾‹ï¼š

```json
{
  "id": "chatcmpl-xxx",
  "object": "chat.completion",
  "created": 1710000000,
  "model": "glm-4.5",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "æœç´¢ç»“æœå’Œå›ç­”å†…å®¹",
        "tool_calls": [
          {
            "id": "call_xxx",
            "type": "web_search",
            "web_search": {
              "query": "æœç´¢å…³é”®è¯",
              "results": [
                {
                  "title": "ç½‘é¡µæ ‡é¢˜",
                  "url": "https://example.com",
                  "snippet": "ç½‘é¡µæ‘˜è¦å†…å®¹"
                }
              ]
            }
          }
        ]
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 20,
    "total_tokens": 30
  }
}
```

## 7. é”™è¯¯å¤„ç†å’Œæ³¨æ„äº‹é¡¹

### 7.1 å¸¸è§é”™è¯¯ç 

- `401 Unauthorized`: API Keyæ— æ•ˆæˆ–ç¼ºå¤±
- `400 Bad Request`: è¯·æ±‚å‚æ•°æ ¼å¼é”™è¯¯
- `429 Too Many Requests`: è¶…å‡ºè°ƒç”¨é¢‘ç‡é™åˆ¶
- `500 Internal Server Error`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### 7.2 é‡è¦æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**ï¼šåœ¨Flutter Webä¸­ï¼Œä¸è¦å°†API Keyç¡¬ç¼–ç åœ¨å‰ç«¯ä»£ç ä¸­ï¼Œå»ºè®®é€šè¿‡åç«¯ä»£ç†æˆ–ç¯å¢ƒå˜é‡ç®¡ç†
2. **CORSé—®é¢˜**ï¼šåœ¨Webç¯å¢ƒä¸­ï¼Œå¯èƒ½éœ€è¦é…ç½®CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰ã€‚å¦‚æœé‡åˆ°CORSé—®é¢˜ï¼Œå»ºè®®åœ¨åç«¯åˆ›å»ºä»£ç†API
3. **å¥—é¤é™åˆ¶**ï¼šè”ç½‘æœç´¢åŠŸèƒ½ä»…åœ¨Proã€Maxå¥—é¤ä¸­å¯ç”¨ï¼ŒLiteå¥—é¤æš‚ä¸æ”¯æŒæœç´¢å·¥å…·
4. **ç½‘ç»œæœç´¢å¯ç”¨**ï¼šè¯­è¨€æ¨¡å‹é»˜è®¤å¯ç”¨web_searchå·¥å…·ï¼Œå¦‚éœ€ç¦ç”¨éœ€è¦æ˜¾å¼è®¾ç½®
5. **æ„å›¾è¯†åˆ«**ï¼šWeb Search APIè¿”å›çš„ç»“æœç»è¿‡æ„å›¾è¯†åˆ«ä¼˜åŒ–ï¼Œæ›´é€‚åˆå¤§æ¨¡å‹å¤„ç†

## 8. æœ€ä½³å®è·µå»ºè®®

1. **é”™è¯¯é‡è¯•æœºåˆ¶**ï¼šåœ¨ç½‘ç»œä¸ç¨³å®šæ—¶å®ç°è‡ªåŠ¨é‡è¯•
2. **è¯·æ±‚é™æµ**ï¼šé¿å…çŸ­æ—¶é—´å†…å¤§é‡è¯·æ±‚å¯¼è‡´è¢«é™æµ
3. **ç¼“å­˜ç­–ç•¥**ï¼šå¯¹ç›¸åŒæŸ¥è¯¢ç»“æœè¿›è¡Œç¼“å­˜ï¼Œå‡å°‘APIè°ƒç”¨
4. **ç”¨æˆ·åé¦ˆ**ï¼šæä¾›æœç´¢ç»“æœè´¨é‡åé¦ˆæœºåˆ¶
5. **ç›‘æ§ç»Ÿè®¡**ï¼šè®°å½•APIè°ƒç”¨æƒ…å†µï¼Œç›‘æ§ä½¿ç”¨é‡å’Œæˆæœ¬

## 9. å‚è€ƒèµ„æº

- æ™ºè°±AIå¼€æ”¾å¹³å°å®˜ç½‘ï¼šhttps://bigmodel.cn
- APIæ–‡æ¡£ä¸­å¿ƒï¼šhttps://open.bigmodel.cn/dev/api
- Reactå®˜æ–¹æ–‡æ¡£ï¼šhttps://react.dev/

é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œæ‚¨å¯ä»¥åœ¨Reactæ„å»ºçš„Webé¡µé¢ä¸­æˆåŠŸé›†æˆæ™ºè°±GLMçš„æœç´¢APIåŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æä¾›å¼ºå¤§çš„AIæœç´¢ä½“éªŒã€‚

---

**é‡è¦è¯´æ˜**ï¼šæœ¬æ–‡æ¡£ä¸­å…³äºFlutter Webçš„å®ç°ç¤ºä¾‹ä¸ºåŸå§‹æŠ€æœ¯é€‰å‹å‚è€ƒã€‚å®é™…é¡¹ç›®ä¸­å‰ç«¯å·²é‡‡ç”¨React + TypeScript + ViteæŠ€æœ¯æ ˆï¼Œç›¸å…³APIé›†æˆå·²åœ¨Reactå‰ç«¯ä¸­å®ç°ã€‚

---

## å…­ã€é¡¹ç›®å½“å‰çŠ¶æ€ï¼ˆ2025å¹´11æœˆæ›´æ–°ï¼‰

### âœ… å·²å®ç°åŠŸèƒ½

1. **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ**
   - âœ… æ³¨å†Œ/ç™»å½•åŠŸèƒ½
   - âœ… JWTä»¤ç‰Œç®¡ç†
   - âœ… è®¤è¯çŠ¶æ€æŒä¹…åŒ–

2. **è¡Œç¨‹ç®¡ç†**
   - âœ… åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤è¡Œç¨‹
   - âœ… è¡Œç¨‹åˆ—è¡¨å±•ç¤º
   - âœ… è¡Œç¨‹è¯¦æƒ…é¡µé¢
   - âœ… æ´»åŠ¨ç®¡ç†
   - âœ… è¡Œç¨‹çŠ¶æ€ç®¡ç†

3. **AIæ™ºèƒ½è§„åˆ’**
   - âœ… åŸºäºOpenAI APIçš„è¡Œç¨‹è§„åˆ’
   - âœ… æµå¼å“åº”å’Œå®æ—¶æ˜¾ç¤º
   - âœ… AIå“åº”æ ¼å¼éªŒè¯å’Œé‡è¯•
   - âœ… å¤šAIæä¾›å•†æ”¯æŒ

4. **åœ°å›¾å¯¼èˆªç³»ç»Ÿ**
   - âœ… Leafletåœ°å›¾é›†æˆ
   - âœ… åœ°ç‚¹æœç´¢åŠŸèƒ½ï¼ˆä½¿ç”¨Nominatim APIï¼‰
   - âœ… åœ°å›¾æ ‡è®°å’Œä¿¡æ¯çª—å£
   - âœ… é©¾è½¦è·¯çº¿è§„åˆ’ï¼ˆä½¿ç”¨OSRMï¼‰
   - âœ… å¤šå›½å®¶åœ°å›¾æ”¯æŒ

5. **è¯­éŸ³è¯†åˆ«é›†æˆ**
   - âœ… ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«æœåŠ¡
   - âœ… è¯­éŸ³è¾“å…¥æ—…è¡Œéœ€æ±‚
   - âœ… å®æ—¶è¯­éŸ³è¯†åˆ«çŠ¶æ€æ˜¾ç¤º
   - âœ… WebSocketå®æ—¶é€šä¿¡
   - âœ… éŸ³é¢‘å½•åˆ¶å’Œé‡é‡‡æ ·å¤„ç†

6. **APIå¯†é’¥ç®¡ç†**
   - âœ… ç”¨æˆ·çº§APIå¯†é’¥é…ç½®
   - âœ… å¤šæœåŠ¡APIå¯†é’¥ç®¡ç†
   - âœ… å‰ç«¯åŠ å¯†å­˜å‚¨å’Œè‡ªåŠ¨è§£å¯†

7. **å“åº”å¼UIè®¾è®¡**
   - âœ… æ¨ªå±å’Œç«–å±è‡ªé€‚åº”å¸ƒå±€
   - âœ… ç°ä»£åŒ–çš„Tailwind CSSç•Œé¢
   - âœ… æµç•…çš„åŠ¨ç”»å’Œäº¤äº’æ•ˆæœ

### ğŸ”„ å¼€å‘ä¸­åŠŸèƒ½

1. **é¢„ç®—åˆ†æåŠŸèƒ½**
   - â³ åŸºäºAIçš„é¢„ç®—åˆ†æ
   - â³ è´¹ç”¨ç»Ÿè®¡å’Œä¼˜åŒ–å»ºè®®
   - â³ é¢„ç®—ä¸å®é™…å¼€é”€å¯¹æ¯”

2. **SRPå®‰å…¨è®¤è¯**
   - â³ å®‰å…¨è¿œç¨‹å¯†ç åè®®å®Œæ•´å®ç°
   - â³ é›¶çŸ¥è¯†è¯æ˜è®¤è¯æœºåˆ¶
   - â³ ç›¸äº’èº«ä»½éªŒè¯

3. **é«˜çº§åœ°å›¾åŠŸèƒ½**
   - â³ å…¬äº¤è·¯çº¿è§„åˆ’
   - â³ å¤šäº¤é€šæ–¹å¼æ”¯æŒï¼ˆæ­¥è¡Œã€éª‘è¡Œï¼‰
   - â³ å®æ—¶äº¤é€šä¿¡æ¯

### ğŸ“‹ æŠ€æœ¯å®ç°è¯´æ˜

- **å‰ç«¯**: React + TypeScript + Vite + Tailwind CSS
- **åç«¯**: Python + FastAPI + SQLite
- **åœ°å›¾æœåŠ¡**: Leaflet + OpenStreetMap + Nominatim + OSRM
- **AIæœåŠ¡**: OpenAI API (é»˜è®¤DeepSeek-chat)
- **è¯­éŸ³è¯†åˆ«**: ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«API
- **åŒ…ç®¡ç†**: uv (Python) + npm (Node.js)

### ğŸ¯ ä¸‹ä¸€æ­¥å¼€å‘é‡ç‚¹

1. å®Œå–„é¢„ç®—åˆ†æåŠŸèƒ½
2. å®ç°SRPå®‰å…¨è®¤è¯åè®®
3. ä¼˜åŒ–è¯­éŸ³è¯†åˆ«ç”¨æˆ·ä½“éªŒ
4. æ·»åŠ æ›´å¤šåœ°å›¾åŠŸèƒ½
